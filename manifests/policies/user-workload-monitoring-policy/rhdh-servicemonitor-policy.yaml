apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: rhdh-servicemonitor
spec:
  remediationAction: enforce
  severity: low
  object-templates-raw: |
    {{ range (lookup "v1" "Namespace" "" "").items }}
    {{ if regexMatch "^rhdh-team.*" .metadata.name }}
    - complianceType: musthave
      objectDefinition:
        apiVersion: monitoring.coreos.com/v1
        kind: ServiceMonitor
        metadata:
          name: rhdh-servicemonitor
          namespace: {{ .metadata.name }}
        spec:
          endpoints:
          - interval: 30s
            port: http-metrics
            scheme: http
            path: /metrics
          selector:
            matchLabels:
              app.kubernetes.io/instance: {{ .metadata.name }}
    {{ end }}
    {{ end }}